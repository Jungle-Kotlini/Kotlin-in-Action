10.2 리플렉션: 런타임에서 Kotlin 객체 살펴보기
리플렉션(Reflection)은 프로그램 실행 중에 코드 구조를 분석하고 수정할 수 있는 방법입니다. 이를 통해 컴파일 시간에 알 수 없는 객체의 메타데이터를 런타임에 탐색하거나 수정할 수 있습니다. Kotlin의 리플렉션 API는 Java 리플렉션을 확장하여 더 직관적이고 안전하게 사용할 수 있도록 설계되었습니다.

10.2.1 Kotlin 리플렉션 API: KClass, KCallable, KFunction, KProperty
리플렉션의 핵심은 KClass입니다. KClass는 Java의 java.lang.Class에 해당하며, Kotlin 클래스의 정보를 담고 있습니다. Kotlin의 리플렉션 API는 Java의 리플렉션처럼 복잡하지 않으며, 더욱 강력하고 타입 안전성을 제공합니다.

KClass 사용 예
Kotlin에서 클래스 참조는 ::class를 사용하여 얻을 수 있습니다. 다음은 Person 클래스의 메타데이터를 참조하는 방법입니다.

kotlin
코드 복사
class Person(val name: String, val age: Int)

val person = Person("Alice", 29)
val kClass = person.javaClass.kotlin
println(kClass.simpleName) // 출력: Person
simpleName: 클래스의 이름을 가져옵니다.
javaClass.kotlin: Kotlin에서 Java 클래스를 Kotlin 클래스(KClass)로 변환합니다.
Kotlin 리플렉션 API는 클래스의 멤버들, 즉 메서드와 프로퍼티에 접근할 수 있는 다양한 방법을 제공합니다. KClass의 중요한 멤버들은 다음과 같습니다:

members: 클래스에 정의된 모든 멤버(메서드, 프로퍼티 등)를 포함합니다.
constructors: 클래스의 생성자를 나타내며, KFunction의 컬렉션으로 반환됩니다.
memberProperties: 클래스의 모든 프로퍼티 목록을 반환합니다.
nestedClasses: 중첩된 클래스를 나타내는 KClass 객체의 컬렉션을 반환합니다.
KClass 주요 멤버들 예시
kotlin
코드 복사
class Person(val name: String, val age: Int)

val kClass = Person::class
println(kClass.simpleName) // 출력: Person
kClass.memberProperties.forEach { println(it.name) } // 출력: name, age
위의 코드는 Person 클래스의 이름을 출력하고, 그 클래스에 포함된 모든 프로퍼티를 출력합니다.

KCallable
리플렉션에서 클래스의 함수나 프로퍼티에 접근할 때는 KCallable 인터페이스를 사용합니다. KCallable은 호출할 수 있는 모든 객체를 나타내며, 함수와 프로퍼티 모두를 추상화합니다. 이 인터페이스는 call 메서드를 제공하여 객체의 메서드나 프로퍼티를 동적으로 호출할 수 있습니다.

KCallable 사용 예
kotlin
코드 복사
fun foo(x: Int) = println(x)

val kFunction = ::foo
kFunction.call(42) // 출력: 42
::foo: foo 함수에 대한 참조를 가져옵니다.
call: 인자를 전달하여 함수를 호출합니다.
KCallable의 기본 구조
kotlin
코드 복사
interface KCallable<out R> {
    fun call(vararg args: Any?): R
}
이 인터페이스를 통해 다양한 메서드를 호출할 수 있습니다. call 메서드는 가변 인자를 받아 해당 함수를 실행한 결과를 반환합니다.

KFunction
KFunction은 KCallable의 하위 타입으로, 함수에 특화된 리플렉션 기능을 제공합니다. 이 인터페이스는 함수의 파라미터와 반환 타입에 접근할 수 있는 메서드를 제공합니다.

KFunction 사용 예
kotlin
코드 복사
fun sum(a: Int, b: Int): Int = a + b

val kFunction: KFunction2<Int, Int, Int> = ::sum
println(kFunction.call(1, 2)) // 출력: 3
KFunction2: 두 개의 파라미터를 받는 함수 타입입니다. 제네릭 인자는 각각 함수의 파라미터와 반환 타입을 나타냅니다.
call: 함수에 인자를 전달하고 실행합니다.
KProperty
KProperty는 프로퍼티(속성)를 나타내는 인터페이스로, 이를 통해 객체의 프로퍼티에 접근하거나 값을 수정할 수 있습니다. KProperty는 읽기 전용 프로퍼티를 나타내는 KProperty1과 읽고 쓸 수 있는 프로퍼티를 나타내는 KMutableProperty1로 나뉩니다.

KProperty 사용 예
kotlin
코드 복사
class Person(val name: String, var age: Int)

val person = Person("Alice", 29)
val kProperty = Person::name
println(kProperty.get(person)) // 출력: Alice
Person::name: name 프로퍼티에 대한 참조를 가져옵니다.
get: 해당 객체의 프로퍼티 값을 가져옵니다.
10.2.2 리플렉션을 사용한 객체 직렬화 구현
리플렉션을 사용하면 객체를 JSON 형식으로 직렬화할 수 있습니다. 직렬화는 객체의 모든 프로퍼티를 문자열로 변환하는 과정입니다. 이를 위해 리플렉션을 사용하여 객체의 모든 프로퍼티에 동적으로 접근할 수 있습니다.

객체 직렬화 예
kotlin
코드 복사
fun serialize(obj: Any): String = buildString { serializeObject(obj) }

private fun StringBuilder.serializeObject(obj: Any) {
    val kClass = obj.javaClass.kotlin
    val properties = kClass.memberProperties
    properties.joinToString(this, prefix = "{", postfix = "}") { prop ->
        serializeString(prop.name)
        append(": ")
        serializePropertyValue(prop.get(obj))
    }
}
이 예제에서:

serializeObject는 객체의 모든 프로퍼티를 순회하며, 각각을 JSON 형식으로 직렬화합니다.
prop.get(obj): 각 프로퍼티 값을 가져옵니다.
joinToString: 모든 프로퍼티를 문자열로 변환해 JSON 형식을 만듭니다.
이 방식으로 객체를 간단하게 JSON 형식으로 변환할 수 있습니다.

10.2.3 애노테이션을 사용한 직렬화 커스터마이징
애노테이션을 사용하여 기본 직렬화 로직을 변경하거나 특정 프로퍼티를 직렬화에서 제외할 수 있습니다. 예를 들어, @JsonExclude 애노테이션을 사용하면 특정 프로퍼티를 JSON 직렬화에서 제외할 수 있습니다.

예시: @JsonExclude 및 @JsonName 사용
kotlin
코드 복사
data class Person(
    @JsonName("alias") val firstName: String,
    @JsonExclude val age: Int? = null
)
@JsonName("alias"): JSON 직렬화 시 firstName을 "alias"라는 이름으로 직렬화합니다.
@JsonExclude: age 프로퍼티를 JSON 직렬화에서 제외합니다.
이러한 애노테이션을 통해 직렬화 방식을 커스터마이징할 수 있습니다.

10.2.4 JSON 파싱과 객체 역직렬화
리플렉션을 사용하여 JSON 데이터를 파싱하고, 이를 기반으로 객체를 역직렬화할 수 있습니다. 역직렬화는 JSON 문자열을 객체로 변환하는 과정입니다. KCallable.callBy 메서드를 사용하여 인자가 있는 생성자를 호출하고, 파라미터에 따라 객체를 생성할 수 있습니다.

KCallable.callBy 예
kotlin
코드 복사
interface KCallable<out R> {
    fun callBy(args: Map<KParameter, Any?>): R
}
callBy는 파라미터 이름과 값을 Map으로 전달받아, 파라미터에 맞는 값을 생성자에 전달합니다. 이를 통해 객체를 동적으로 생성할 수 있습니다. 이때 제공되지 않은 파라미터는 기본값이 사용됩니다.

JSON 역직렬화 예시
kotlin
코드 복사
fun deserialize(json: String, kClass: KClass<*>): Any {
    val constructor = kClass.constructors.first()
    val args = parseJson(json)
    return constructor.callBy(args)
}
이 코드는 JSON 문자열을 파싱한 후, 해당 클래스의 생성자를 호출하여 객체를 생성하는 예입니다.